{% extends "layout.html" %}
{% block content %}
<div class="container-fluid mt-4">
  <!-- Botón para volver al listado -->
  <div class="mb-3">
    <a href="{{ url_for('hojas_trabajo_bp.listar_hojas') }}" class="btn btn-info" title="Volver al listado de hojas de trabajo">Ver Lista de Hojas de Trabajo</a>
  </div>
  <h2 title="Hoja de Trabajo">Hoja de Trabajo</h2>
  
  <!-- Encabezado con datos básicos -->
  <div class="row mb-3">
    <div class="col-md">
      <label class="form-label" for="referencia">Referencia</label>
      <input type="text" class="form-control" id="referencia" name="referencia" value="{{ hoja.referencia }}" readonly title="Referencia" placeholder="Referencia">
    </div>
    <div class="col-md">
      <label class="form-label" for="fecha">Fecha</label>
      <input type="date" class="form-control" id="fecha" name="fecha" value="{{ hoja.fecha }}" readonly title="Fecha" placeholder="Fecha">
    </div>
    <div class="col-md">
      <label class="form-label" for="tecnico_encargado">Técnico Encargado</label>
      <input type="text" class="form-control" id="tecnico_encargado" name="tecnico_encargado" value="{{ hoja.tecnico_encargado|default('Sin asignar') }}" title="Técnico Encargado" placeholder="Técnico Encargado">
    </div>
    <div class="col-md">
      <label class="form-label" for="cliente">Cliente</label>
      <input type="text" class="form-control" id="cliente" name="cliente" value="{{ hoja.cliente|default('') }}" readonly title="Cliente" placeholder="Cliente">
    </div>
    <div class="col-md">
      <label class="form-label" for="nombre_proyecto">Nombre de Proyecto</label>
      <input type="text" class="form-control" id="nombre_proyecto" name="nombre_proyecto" value="{{ hoja.nombre_proyecto }}" readonly title="Nombre de Proyecto" placeholder="Nombre de Proyecto">
    </div>
  </div>
  
  <!-- Formulario para editar capítulos y partidas -->
  <form method="post" action="{{ url_for('hojas_trabajo_bp.editar_hoja_trabajo', id=hoja.id) }}">
    <div id="capitulosContainer">
      {% if capitulos %}
        {% for cap in capitulos %}
          {% set chap_idx = loop.index0 %}
          <div class="card mb-3" data-capitulo-index="{{ chap_idx }}">
            <div class="card-header">
              <div class="row align-items-center">
                <div class="col-auto">
                  <h4 class="mb-0" title="Capítulo {{ loop.index }}">Capítulo {{ loop.index }}</h4>
                </div>
                <div class="col">
                  <input type="text" class="form-control" name="capitulos[{{ chap_idx }}][descripcion]" value="{{ cap.descripcion }}" placeholder="Descripción del capítulo" required title="Descripción del capítulo">
                </div>
              </div>
            </div>
            <div class="card-body">
              {% if cap.partidas %}
                {% for part in cap.partidas %}
                  {% set part_idx = loop.index0 %}
                  <div class="mb-3 border p-2">
                    <!-- Primera fila: Número y Descripción -->
                    <div class="row">
                      <div class="col-1">
                        <label class="form-label small-label" title="Número">No.</label>
                        <div class="fw-bold" title="Número de partida">{{ part.capitulo_numero }}</div>
                      </div>
                      <div class="col-11">
                        <label class="form-label small-label" title="Descripción">Descripción</label>
                        <input type="text" class="form-control" name="capitulos[{{ chap_idx }}][partidas][{{ part_idx }}][descripcion]" value="{{ part.descripcion }}" placeholder="Descripción" required title="Descripción de la partida">
                      </div>
                    </div>
                    <!-- Segunda fila: Campos Unitario, Cantidad, Precio, Total, Margen, Final -->
                    <div class="row mt-2">
                      <div class="col">
                        <label class="form-label small-label" title="Unitario">Unitario</label>
                        <input type="text" class="form-control" name="capitulos[{{ chap_idx }}][partidas][{{ part_idx }}][unitario]" value="{{ part.unitario }}" placeholder="Unitario" required title="Unidad de medida">
                      </div>
                      <div class="col">
                        <label class="form-label small-label" title="Cantidad">Cantidad</label>
                        <input type="number" step="any" class="form-control" name="capitulos[{{ chap_idx }}][partidas][{{ part_idx }}][cantidad]" value="{{ part.cantidad }}" placeholder="Cantidad" required title="Cantidad">
                      </div>
                      <div class="col">
                        <label class="form-label small-label" title="Precio (€)">Precio (€)</label>
                        <input type="number" step="any" class="form-control" name="capitulos[{{ chap_idx }}][partidas][{{ part_idx }}][precio]" value="{{ part.precio }}" placeholder="Precio" required title="Precio en euros">
                      </div>
                      <div class="col">
                        <label class="form-label small-label" title="Total">Total</label>
                        <input type="number" step="any" class="form-control" name="capitulos[{{ chap_idx }}][partidas][{{ part_idx }}][total]" value="{{ part.total }}" placeholder="Total" readonly title="Total">
                      </div>
                      <div class="col">
                        <label class="form-label small-label" title="Margen (%)">Margen (%)</label>
                        <input type="number" step="any" class="form-control" name="capitulos[{{ chap_idx }}][partidas][{{ part_idx }}][margen]" value="{{ part.margen }}" placeholder="Margen (%)" required title="Margen de beneficio en porcentaje">
                      </div>
                      <div class="col">
                        <label class="form-label small-label" title="Final">Final</label>
                        <input type="number" step="any" class="form-control" name="capitulos[{{ chap_idx }}][partidas][{{ part_idx }}][final]" value="{{ part.final }}" placeholder="Final" readonly title="Precio final">
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <p>No hay partidas para este capítulo.</p>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p>No hay capítulos asignados.</p>
      {% endif %}
    </div>
    
    <!-- Botones de acción -->
    <div class="mt-3 d-flex justify-content-end">
      <button type="submit" class="btn btn-success" title="Guardar Cambios">Guardar Cambios</button>
      <a href="{{ url_for('hojas_trabajo_bp.listar_hojas') }}" class="btn btn-secondary ms-2" title="Cancelar">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}
