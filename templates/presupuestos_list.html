{% extends "layout.html" %}
{% block content %}
<div class="container-fluid mt-4">
  <h2>Presupuestos</h2>
  
  <!-- Contenedor de Filtros Avanzados -->
  <div class="card mb-3">
    <div class="card-header">Filtros Avanzados</div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Filtro Fecha (Desde y Hasta) -->
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="filterFechaCheck">
            <label class="form-check-label" for="filterFechaCheck">Fecha</label>
          </div>
          <div class="input-group mt-1">
            <span class="input-group-text">Desde</span>
            <input type="date" id="filterFechaDesde" class="form-control" disabled>
          </div>
          <div class="input-group mt-1">
            <span class="input-group-text">Hasta</span>
            <input type="date" id="filterFechaHasta" class="form-control" disabled>
          </div>
        </div>
        <!-- Filtro Técnico Encargado -->
        <div class="col-md-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="filterTecnicoCheck">
            <label class="form-check-label" for="filterTecnicoCheck">Técnico</label>
          </div>
          <select id="filterTecnico" class="form-select" disabled>
            <option value="">Todos</option>
            <option value="Toni">Toni</option>
            <option value="Alejandro">Alejandro</option>
            <option value="Blas">Blas</option>
          </select>
        </div>
        <!-- Filtro Tipo de Proyecto -->
        <div class="col-md-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="filterTipoCheck">
            <label class="form-check-label" for="filterTipoCheck">Tipo Proyecto</label>
          </div>
          <select id="filterTipo" class="form-select" disabled>
            <option value="">Todos</option>
            <!-- Opciones de ejemplo; ajusta según tus datos -->
            <option value="tipo1">Tipo1</option>
            <option value="tipo2">Tipo2</option>
            <option value="tipo3">Tipo3</option>
          </select>
        </div>
        <!-- Filtro Estado -->
        <div class="col-md-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="filterEstadoCheck">
            <label class="form-check-label" for="filterEstadoCheck">Estado</label>
          </div>
          <select id="filterEstado" class="form-select" disabled>
            <option value="">Todos</option>
            <option value="En estudio">En estudio</option>
            <option value="Estudiado">Estudiado</option>
            <option value="Revision">Revision</option>
            <option value="Enviado">Enviado</option>
            <option value="Pendiente de envio">Pendiente de envio</option>
            <option value="Ejecutado en ejecucion">Ejecutado en ejecucion</option>
          </select>
        </div>
        <!-- Filtro Cliente -->
        <div class="col-md-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="filterClienteCheck">
            <label class="form-check-label" for="filterClienteCheck">Cliente</label>
          </div>
          <select id="filterCliente" class="form-select" disabled>
            <option value="">Todos</option>
            <!-- Opciones de ejemplo; reemplaza por tus datos -->
            <option value="cliente1">Cliente1</option>
            <option value="cliente2">Cliente2</option>
            <option value="cliente3">Cliente3</option>
          </select>
        </div>
      </div>
      <button id="applyFilters" class="btn btn-primary mt-3">Aplicar Filtros</button>
    </div>
  </div>
  
  <!-- Filtro de Búsqueda Sencillo (sin tick) -->
  <div class="mb-3">
    <label for="searchInput" class="form-label">Buscar:</label>
    <input type="text" id="searchInput" class="form-control" placeholder="Ingresa texto para buscar...">
  </div>
  
  <table class="table table-striped" id="presupuestosTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Referencia</th>
        <th>Fecha</th>
        <th>Cliente</th>
        <th>Tipo Proyecto</th>
        <th>Nombre Proyecto</th>
        <th>Técnico Encargado</th>
        <th>Aprobación</th>
        <th>Fecha Aprobación</th>
        <th>Estado</th>
        <th>Hoja</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for p in presupuestos %}
      <tr data-id="{{ p[0] }}"
          class="{% if p[7]=='aceptado' %}table-success{% elif p[7]=='rechazado' %}table-danger{% endif %}">
        <td>{{ p[0] }}</td>
        <td>{{ p[1] }}</td>
        <td>{{ p[2] }}</td>
        <td>{{ p[3] }}</td>
        <td>{{ p[4] }}</td>
        <td>{{ p[5] }}</td>
        <td>
          <select class="form-select tecnico-select" title="Seleccione técnico encargado">
            <option value="Toni" {% if p[6]=='Toni' %}selected{% endif %}>Toni</option>
            <option value="Alejandro" {% if p[6]=='Alejandro' %}selected{% endif %}>Alejandro</option>
            <option value="Blas" {% if p[6]=='Blas' %}selected{% endif %}>Blas</option>
          </select>
        </td>
        <td>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input estado-radio" name="estado_{{ p[0] }}" value="aceptado" {% if p[7]=='aceptado' %}checked{% endif %} title="Aprobado">
            <label class="form-check-label" title="Aprobado">Aceptado</label>
          </div>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input estado-radio" name="estado_{{ p[0] }}" value="rechazado" {% if p[7]=='rechazado' %}checked{% endif %} title="Rechazado">
            <label class="form-check-label" title="Rechazado">Rechazado</label>
          </div>
        </td>
        <td>
          <input type="text" class="form-control fecha-aprobacion" readonly value="{{ p[8] or '' }}" title="Fecha de aprobación" placeholder="Fecha de aprobación">
        </td>
        <td>
          <select class="form-select estado-select" title="Seleccione estado">
            <option value="En estudio" {% if p[9]=='En estudio' %}selected{% endif %}>En estudio</option>
            <option value="Estudiado" {% if p[9]=='Estudiado' %}selected{% endif %}>Estudiado</option>
            <option value="Revision" {% if p[9]=='Revision' %}selected{% endif %}>Revision</option>
            <option value="Enviado" {% if p[9]=='Enviado' %}selected{% endif %}>Enviado</option>
            <option value="Pendiente de envio" {% if p[9]=='Pendiente de envio' %}selected{% endif %}>Pendiente de envio</option>
            <option value="Ejecutado en ejecucion" {% if p[9]=='Ejecutado en ejecucion' %}selected{% endif %}>Ejecutado en ejecucion</option>
          </select>
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-warning hoja-btn" data-presupuesto-id="{{ p[0] }}" title="Abrir hoja de trabajo" style="border-radius: 0.25rem; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);">H.Trabajo</button>
        </td>
        <td>
          <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-sm btn-secondary modificar-btn" title="Editar presupuesto" style="border-radius: 0.25rem; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);">Editar</button>
            <button type="button" class="btn btn-sm btn-primary guardar-btn" title="Guardar cambios" style="border-radius: 0.25rem; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);">Guardar</button>
            <form action="{{ url_for('presupuestos_bp.borrar_presupuesto', id=p[0]) }}" method="post" class="d-inline" onsubmit="return confirm('¿Está seguro de borrar este presupuesto?');">
              <button type="submit" class="btn btn-sm btn-danger" title="Borrar presupuesto" style="border-radius: 0.25rem; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);">Borrar</button>
            </form>
            <form action="{{ url_for('presupuestos_bp.clonar_presupuesto', id=p[0]) }}" method="post" class="d-inline">
              <button type="submit" class="btn btn-sm btn-info" title="Clonar presupuesto" style="border-radius: 0.25rem; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);">Clonar</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal para Hoja de Trabajo -->
<div class="modal fade" id="hojaModal" tabindex="-1" aria-labelledby="hojaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="hojaModalLabel" title="Hoja de Trabajo">Hoja de Trabajo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" title="Cerrar"></button>
      </div>
      <div class="modal-body" title="Opciones de Hoja de Trabajo">
        ¿Generar nuevo archivo o acceder al archivo generado anteriormente?
      </div>
      <div class="modal-footer">
        <form id="generarNuevoForm" method="post" class="d-inline">
          <button type="submit" class="btn btn-primary" title="Generar nuevo archivo de trabajo" style="border-radius: 0.25rem; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);">Generar Nuevo</button>
        </form>
        <a href="{{ url_for('hojas_trabajo_bp.listar_hojas') }}" class="btn btn-secondary" title="Editar archivo existente" style="border-radius: 0.25rem; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);">Editar Archivo</a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function(){
    // Habilitar/deshabilitar cada filtro según el tick
    document.getElementById("filterFechaCheck").addEventListener("change", function() {
      document.getElementById("filterFechaDesde").disabled = !this.checked;
      document.getElementById("filterFechaHasta").disabled = !this.checked;
    });
    document.getElementById("filterTecnicoCheck").addEventListener("change", function() {
      document.getElementById("filterTecnico").disabled = !this.checked;
    });
    document.getElementById("filterTipoCheck").addEventListener("change", function() {
      document.getElementById("filterTipo").disabled = !this.checked;
    });
    document.getElementById("filterEstadoCheck").addEventListener("change", function() {
      document.getElementById("filterEstado").disabled = !this.checked;
    });
    document.getElementById("filterClienteCheck").addEventListener("change", function() {
      document.getElementById("filterCliente").disabled = !this.checked;
    });
  
    function applyAllFilters() {
      // Valores de filtros avanzados
      var filterFechaActive = document.getElementById("filterFechaCheck").checked;
      var fechaDesde = document.getElementById("filterFechaDesde").value;
      var fechaHasta = document.getElementById("filterFechaHasta").value;
      var filterTecnicoActive = document.getElementById("filterTecnicoCheck").checked;
      var filterTecnico = document.getElementById("filterTecnico").value.toLowerCase();
      var filterTipoActive = document.getElementById("filterTipoCheck").checked;
      var filterTipo = document.getElementById("filterTipo").value.toLowerCase();
      var filterEstadoActive = document.getElementById("filterEstadoCheck").checked;
      var filterEstado = document.getElementById("filterEstado").value.toLowerCase();
      var filterClienteActive = document.getElementById("filterClienteCheck").checked;
      var filterCliente = document.getElementById("filterCliente").value.toLowerCase();
  
      // Valor del filtro de búsqueda sencillo
      var searchValue = document.getElementById("searchInput").value.toLowerCase();
  
      var rows = document.querySelectorAll("#presupuestosTable tbody tr");
      rows.forEach(function(row) {
        // Se usan innerText para capturar el contenido visible
        var fechaText = row.cells[2].innerText.trim();
        var clienteText = row.cells[3].innerText.trim().toLowerCase();
        var tipoText = row.cells[4].innerText.trim().toLowerCase();
        var tecnicoText = row.cells[6].innerText.trim().toLowerCase();
        var estadoText = row.cells[9].innerText.trim().toLowerCase();
        var rowText = row.innerText.toLowerCase();
  
        var showRow = true;
  
        // Filtro por fecha (columna 2) si está activo y la celda contiene una fecha
        if (filterFechaActive && fechaText) {
          var rowDate = new Date(fechaText);
          if (!isNaN(rowDate)) {  // solo si la fecha es válida
            if (fechaDesde) {
              var desdeDate = new Date(fechaDesde);
              if (rowDate < desdeDate) showRow = false;
            }
            if (fechaHasta) {
              var hastaDate = new Date(fechaHasta);
              if (rowDate > hastaDate) showRow = false;
            }
          }
        }
  
        // Filtro por técnico (columna 6)
        if (filterTecnicoActive && filterTecnico !== "" && tecnicoText.indexOf(filterTecnico) === -1) {
          showRow = false;
        }
        // Filtro por tipo de proyecto (columna 4)
        if (filterTipoActive && filterTipo !== "" && tipoText.indexOf(filterTipo) === -1) {
          showRow = false;
        }
        // Filtro por estado (columna 9)
        if (filterEstadoActive && filterEstado !== "" && estadoText.indexOf(filterEstado) === -1) {
          showRow = false;
        }
        // Filtro por cliente (columna 3)
        if (filterClienteActive && filterCliente !== "" && clienteText.indexOf(filterCliente) === -1) {
          showRow = false;
        }
        // Filtro de búsqueda sencillo: se revisa todo el contenido de la fila
        if (searchValue && rowText.indexOf(searchValue) === -1) {
          showRow = false;
        }
        row.style.display = showRow ? "" : "none";
      });
    }
  
    // Evento para el botón "Aplicar Filtros"
    document.getElementById("applyFilters").addEventListener("click", function(){
      applyAllFilters();
    });
  
    // Evento para el filtro de búsqueda (filtra en tiempo real)
    document.getElementById("searchInput").addEventListener("keyup", function(){
      applyAllFilters();
    });
  
    // Los scripts que ya tenías para el modal, modificar, guardar, etc.
    var hojaModal = new bootstrap.Modal(document.getElementById('hojaModal'));
    
    document.querySelectorAll(".hoja-btn").forEach(function(button) {
      button.addEventListener("click", function(){
        var presupuestoId = this.getAttribute("data-presupuesto-id");
        var generarForm = document.getElementById("generarNuevoForm");
        generarForm.action = "/hojas_trabajo/clonar/" + presupuestoId;
        hojaModal.show();
      });
    });
    
    document.querySelectorAll(".modificar-btn").forEach(function(btn) {
      btn.addEventListener("click", function(){
        var row = this.closest("tr");
        var id = row.getAttribute("data-id");
        window.location.href = "{{ url_for('presupuestos_bp.editar_presupuesto', id=0) }}".replace("0", id);
      });
    });
    
    function guardarCambios(row) {
      var id = row.getAttribute("data-id");
      var tecnico = row.querySelector(".tecnico-select").value;
      var estadoRadio = row.querySelector("input.estado-radio:checked");
      var aprobacion = estadoRadio ? estadoRadio.value : "";
      var fecha_aprobacion = row.querySelector(".fecha-aprobacion").value;
      var estado = row.querySelector(".estado-select").value;
      
      var formData = new FormData();
      formData.append("tecnico", tecnico);
      formData.append("aprobacion", aprobacion);
      formData.append("fecha_aprobacion", fecha_aprobacion);
      formData.append("estado", estado);
      
      fetch("{{ url_for('presupuestos_bp.actualizar_presupuesto_estado', id=0) }}".replace("0", id), {
        method: "POST",
        body: formData
      }).then(response => response.text())
        .then(data => {
          console.log("Cambios guardados correctamente para el presupuesto " + id);
        }).catch(error => {
          console.error("Error al guardar los cambios", error);
        });
    }
    
    document.querySelectorAll("input.estado-radio").forEach(function(radio) {
      radio.addEventListener("change", function(){
        var row = this.closest("tr");
        var fechaInput = row.querySelector(".fecha-aprobacion");
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, "0");
        var dd = String(today.getDate()).padStart(2, "0");
        var todayStr = yyyy + "-" + mm + "-" + dd;
        if (this.value === "aceptado" || this.value === "rechazado") {
          fechaInput.value = todayStr;
        }
        row.classList.remove("table-success", "table-danger");
        if (this.value === "aceptado") {
          row.classList.add("table-success");
        } else if (this.value === "rechazado") {
          row.classList.add("table-danger");
        }
        guardarCambios(row);
      });
    });
    
    document.querySelectorAll(".guardar-btn").forEach(function(btn) {
      btn.addEventListener("click", function(){
        var row = this.closest("tr");
        guardarCambios(row);
      });
    });
  });
  </script>
  
{% endblock %}
