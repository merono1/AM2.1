{% extends "layout.html" %}
{% block content %}
<div class="container-fluid mt-4">
  <h2>Presupuestos</h2>
  <a href="{{ url_for('presupuestos_bp.nuevo_presupuesto') }}" class="btn btn-primary mb-3" title="Crear un nuevo presupuesto">Nuevo Presupuesto</a>
  <table class="table table-striped" id="presupuestosTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Referencia</th>
        <th>Fecha</th>
        <th>Cliente</th>
        <th>Tipo Proyecto</th>
        <th>Nombre Proyecto</th>
        <th>Técnico Encargado</th>
        <th>Aprobación</th>
        <th>Fecha Aprobación</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for p in presupuestos %}
      <tr data-id="{{ p[0] }}"
          class="{% if p[7]=='aceptado' %}table-success{% elif p[7]=='rechazado' %}table-danger{% endif %}">
        <td>{{ p[0] }}</td>
        <td>{{ p[1] }}</td>
        <td>{{ p[2] }}</td>
        <td>{{ p[3] }}</td>
        <td>{{ p[4] }}</td>
        <td>{{ p[5] }}</td>
        <td>
          <select class="form-select tecnico-select" title="Seleccione técnico encargado">
            <option value="Toni" {% if p[6]=='Toni' %}selected{% endif %}>Toni</option>
            <option value="Alejandro" {% if p[6]=='Alejandro' %}selected{% endif %}>Alejandro</option>
            <option value="Blas" {% if p[6]=='Blas' %}selected{% endif %}>Blas</option>
          </select>
        </td>
        <td>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input estado-radio" name="estado_{{ p[0] }}" value="aceptado" {% if p[7]=='aceptado' %}checked{% endif %} title="Aprobado">
            <label class="form-check-label" title="Aprobado">Aceptado</label>
          </div>
          <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input estado-radio" name="estado_{{ p[0] }}" value="rechazado" {% if p[7]=='rechazado' %}checked{% endif %} title="Rechazado">
            <label class="form-check-label" title="Rechazado">Rechazado</label>
          </div>
        </td>
        <td>
          <input type="text" class="form-control fecha-aprobacion" readonly value="{{ p[8] or '' }}" title="Fecha de aprobación" placeholder="Fecha de aprobación">
        </td>
        <td>
          <select class="form-select estado-select" title="Seleccione estado">
            <option value="En estudio" {% if p[9]=='En estudio' %}selected{% endif %}>En estudio</option>
            <option value="Estudiado" {% if p[9]=='Estudiado' %}selected{% endif %}>Estudiado</option>
            <option value="Revision" {% if p[9]=='Revision' %}selected{% endif %}>Revision</option>
            <option value="Enviado" {% if p[9]=='Enviado' %}selected{% endif %}>Enviado</option>
            <option value="Pendiente de envio" {% if p[9]=='Pendiente de envio' %}selected{% endif %}>Pendiente de envio</option>
            <option value="Ejecutado en ejecucion" {% if p[9]=='Ejecutado en ejecucion' %}selected{% endif %}>Ejecutado en ejecucion</option>
          </select>
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-warning hoja-btn" data-presupuesto-id="{{ p[0] }}" title="Abrir hoja de trabajo">Hoja de Trabajo</button>
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-secondary modificar-btn" title="Editar presupuesto">Editar Presupuesto</button>
          <button type="button" class="btn btn-sm btn-outline-primary guardar-btn" title="Guardar cambios">Guardar Cambios</button>
          <form action="{{ url_for('presupuestos_bp.borrar_presupuesto', id=p[0]) }}" method="post" class="d-inline" onsubmit="return confirm('¿Está seguro de borrar este presupuesto?');">
            <button type="submit" class="btn btn-sm btn-outline-danger" title="Borrar presupuesto">Borrar Presupuesto</button>
          </form>
          <form action="{{ url_for('presupuestos_bp.clonar_presupuesto', id=p[0]) }}" method="post" class="d-inline">
            <button type="submit" class="btn btn-sm btn-outline-info" title="Clonar presupuesto">Clonar</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal para Hoja de Trabajo -->
<div class="modal fade" id="hojaModal" tabindex="-1" aria-labelledby="hojaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="hojaModalLabel" title="Hoja de Trabajo">Hoja de Trabajo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" title="Cerrar"></button>
      </div>
      <div class="modal-body" title="Opciones de Hoja de Trabajo">
        ¿Generar nuevo archivo o acceder al archivo generado anteriormente?
      </div>
      <div class="modal-footer">
        <form id="generarNuevoForm" method="post" class="d-inline">
          <button type="submit" class="btn btn-primary" title="Generar nuevo archivo de trabajo">Generar Nuevo</button>
        </form>
        <a href="{{ url_for('hojas_trabajo_bp.listar_hojas') }}" class="btn btn-secondary" title="Editar archivo existente">Editar Archivo</a>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  var presupuestoId = null;
  var hojaModal = new bootstrap.Modal(document.getElementById('hojaModal'));
  
  document.querySelectorAll(".hoja-btn").forEach(function(button) {
    button.addEventListener("click", function(){
      presupuestoId = this.getAttribute("data-presupuesto-id");
      var generarForm = document.getElementById("generarNuevoForm");
      generarForm.action = "/hojas_trabajo/clonar/" + presupuestoId;
      hojaModal.show();
    });
  });
  
  document.querySelectorAll(".modificar-btn").forEach(function(btn) {
    btn.addEventListener("click", function(){
      var row = this.closest("tr");
      var id = row.getAttribute("data-id");
      window.location.href = "{{ url_for('presupuestos_bp.editar_presupuesto', id=0) }}".replace("0", id);
    });
  });
  
  function guardarCambios(row) {
    var id = row.getAttribute("data-id");
    var tecnico = row.querySelector(".tecnico-select").value;
    var estadoRadio = row.querySelector("input.estado-radio:checked");
    var aprobacion = estadoRadio ? estadoRadio.value : "";
    var fecha_aprobacion = row.querySelector(".fecha-aprobacion").value;
    var estado = row.querySelector(".estado-select").value;
    
    var formData = new FormData();
    formData.append("tecnico", tecnico);
    formData.append("aprobacion", aprobacion);
    formData.append("fecha_aprobacion", fecha_aprobacion);
    formData.append("estado", estado);
    
    fetch("{{ url_for('presupuestos_bp.actualizar_presupuesto_estado', id=0) }}".replace("0", id), {
      method: "POST",
      body: formData
    }).then(response => response.text())
      .then(data => {
        console.log("Cambios guardados correctamente para el presupuesto " + id);
      }).catch(error => {
        console.error("Error al guardar los cambios", error);
      });
  }
  
  // Escuchar cambios en los radio buttons de estado
  document.querySelectorAll("input.estado-radio").forEach(function(radio) {
    radio.addEventListener("change", function(){
      var row = this.closest("tr");
      // Actualizar la fecha de aprobación con la fecha actual
      var fechaInput = row.querySelector(".fecha-aprobacion");
      var today = new Date();
      var yyyy = today.getFullYear();
      var mm = String(today.getMonth() + 1).padStart(2, "0");
      var dd = String(today.getDate()).padStart(2, "0");
      var todayStr = yyyy + "-" + mm + "-" + dd;
      if (this.value === "aceptado" || this.value === "rechazado") {
        fechaInput.value = todayStr;
      }
      // Actualizar color de la fila según el estado
      row.classList.remove("table-success", "table-danger");
      if (this.value === "aceptado") {
        row.classList.add("table-success");
      } else if (this.value === "rechazado") {
        row.classList.add("table-danger");
      }
      // Guardar los cambios vía AJAX
      guardarCambios(row);
    });
  });
  
  // También el botón "Guardar Cambios" de cada fila
  document.querySelectorAll(".guardar-btn").forEach(function(btn) {
    btn.addEventListener("click", function(){
      var row = this.closest("tr");
      guardarCambios(row);
    });
  });
});
</script>
{% endblock %}
